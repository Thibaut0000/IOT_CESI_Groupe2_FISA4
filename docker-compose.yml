services:
  influxdb:
    image: influxdb:2.7
    container_name: iot-influxdb
    ports:
      - "8086:8086"
    environment:
      - DOCKER_INFLUXDB_INIT_MODE=setup
      - DOCKER_INFLUXDB_INIT_USERNAME=admin
      - DOCKER_INFLUXDB_INIT_PASSWORD=adminadmin
      - DOCKER_INFLUXDB_INIT_ORG=${INFLUX_ORG}
      - DOCKER_INFLUXDB_INIT_BUCKET=${INFLUX_BUCKET}
      - DOCKER_INFLUXDB_INIT_ADMIN_TOKEN=${INFLUX_TOKEN}
    volumes:
      - ./data/influxdb:/var/lib/influxdb2
    healthcheck:
      test: ["CMD-SHELL", "influx ping || wget -q --spider http://localhost:8086/health"]
      interval: 5s
      timeout: 5s
      retries: 10
      start_period: 10s
    networks:
      - iot_net

  api:
    build: ./backend
    container_name: iot-api
    ports:
      - "${API_PORT}:4000"
    environment:
      - APP_ENV=${APP_ENV}
      - API_PORT=4000
      - JWT_SECRET=${JWT_SECRET}
      - JWT_EXPIRES_IN=${JWT_EXPIRES_IN}
      - LOG_LEVEL=${LOG_LEVEL}
      - MQTT_HOST=${MQTT_HOST}
      - MQTT_PORT=${MQTT_PORT}
      - MQTT_USERNAME=${MQTT_USERNAME}
      - MQTT_PASSWORD=${MQTT_PASSWORD}
      - MQTT_TLS=${MQTT_TLS}
      - MQTT_CA_CERT=${MQTT_CA_CERT}
      - INFLUX_URL=${INFLUX_URL}
      - INFLUX_TOKEN=${INFLUX_TOKEN}
      - INFLUX_ORG=${INFLUX_ORG}
      - INFLUX_BUCKET=${INFLUX_BUCKET}
      - DEFAULT_ADMIN_EMAIL=${DEFAULT_ADMIN_EMAIL}
      - DEFAULT_ADMIN_PASSWORD=${DEFAULT_ADMIN_PASSWORD}
      - OFFLINE_THRESHOLD_SECONDS=${OFFLINE_THRESHOLD_SECONDS}
    volumes:
      - ./backend/data:/app/data
      - ./mosquitto/config/certs:/certs:ro
    depends_on:
      influxdb:
        condition: service_healthy
    networks:
      - iot_net

  web:
    build: ./frontend
    container_name: iot-web
    ports:
      - "5173:80"
    environment:
      - VITE_API_BASE_URL=${VITE_API_BASE_URL}
      - VITE_WS_URL=${VITE_WS_URL}
    depends_on:
      - api
    networks:
      - iot_net

  nginx:
    image: nginx:1.27-alpine
    container_name: iot-nginx
    profiles: ["proxy"]
    ports:
      - "8080:80"
    volumes:
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf:ro
    depends_on:
      - api
      - web
    networks:
      - iot_net

  mosquitto:
    image: eclipse-mosquitto:2.0
    container_name: iot-mosquitto
    profiles: ["local-broker"]
    ports:
      - "1883:1883"
      - "8883:8883"
    volumes:
      - ./mosquitto/config:/mosquitto/config
      - ./mosquitto/data:/mosquitto/data
      - ./mosquitto/log:/mosquitto/log
    networks:
      - iot_net

networks:
  iot_net:
    ipam:
      driver: default
      config:
        - subnet: 172.30.0.0/16